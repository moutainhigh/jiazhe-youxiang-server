<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>CRM首页</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <!-- CSS -->
    <link rel="stylesheet" href="../static/init.css"/>

    <!-- Javascript -->
    <script src="../static/init.js"></script>

    <style>
        .form-group {
            margin-bottom: 0px;
        }
        .buttonDiv{
            padding-top:32px;
        }
    </style>
</head>

<body class="no-skin">

<div class="main-container ace-save-state" id="main-container">
    <script type="text/javascript">
        try{ace.settings.loadState('main-container')}catch(e){}
    </script>

    <div class="main-content">
        <div class="main-content-inner">
            <div class="breadcrumbs ace-save-state" id="breadcrumbs">
                <ul class="breadcrumb">
                    <li>
                        <i class="ace-icon fa fa-home home-icon"></i>
                        <a href="../main/main_center">主页</a>
                    </li>
                    <li>
                        <a href="#">系统管理</a>
                    </li>
                    <li class="active">角色管理</li>
                </ul><!-- /.breadcrumb -->
            </div>

            <div class="page-content">
                <div class="row">
                    <div class="col-xs-12" style="padding-top:40px">
                        <form id="roleSearchForm" class="form-horizontal" role="form">
                            <div class="form-group">
                                <label class="col-sm-1 control-label no-padding-right">角色名称：</label>
                                <div class="col-sm-2">
                                    <div class="pos-rel">
                                        <input id="name" name="name" class="form-control" type="text" style="height:30px"/>
                                    </div>
                                </div>
                                <label class="col-sm-1 control-label no-padding-right">排序：</label>
                                <div class="col-sm-2">
                                    <div class="pos-rel">
                                        <input id="priority" name="priority" class="form-control" type="text" style="height:30px"/>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <button class="btn btn-white btn-default btn-round btn-sm" onclick="return search()">
                                        <i class="ace-icon fa fa-search red2"></i>
                                        查询
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div><!-- /.col -->
                    <div class="col-xs-12" style="text-align: right" id="buttonDiv">
                        <p style="margin:1px;">
                            <shiro:hasPermission name="role:add">
                                <a class="btn btn-success btn-round btn-sm" role="button" href="#modal-form" data-toggle="modal" onclick="openNew()">
                                    <i class="ace-icon fa fa-plus"></i>新建
                                </a>
                            </shiro:hasPermission>
                        </p>
                    </div><!-- /.col -->
                    <div class="col-xs-12">
                        <table id="grid-table"></table>

                        <div id="grid-pager"></div>
                    </div><!-- /.col -->
                    <div id="modal-form" class="modal fade" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h4 class="blue bigger" id="modal-title"></h4>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-1"></div>
                                        <div class="col-xs-12 col-sm-9">
                                            <form id="roleSaveForm" class="form-horizontal" role="form">
                                                <input type="hidden" name="id" id="roleId">
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label no-padding-right">角色名称：</label>
                                                    <div class="col-sm-8">
                                                        <div class="pos-rel">
                                                            <input id="saveName" name="name" class="form-control" type="text" style="height:30px"/>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="space-2"></div>
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label no-padding-right">排序：</label>
                                                    <div class="col-sm-8">
                                                        <div class="pos-rel">
                                                            <input id="savePriority" name="priority" class="form-control" type="text" style="height:30px"/>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="space-2"></div>
                                                <div class="form-group">
                                                    <label class="col-sm-4 control-label no-padding-right">备注：</label>
                                                    <div class="col-sm-8">
                                                        <div class="pos-rel">
                                                            <textarea class="form-control" id="saveRemark" name="remark" style="resize:none"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button class="btn btn-sm modal-footer-btn" data-dismiss="modal">
                                        <i class="ace-icon fa fa-times"></i>
                                        取消
                                    </button>

                                    <button class="btn btn-sm btn-primary modal-footer-btn" onclick="save()">
                                        <i class="ace-icon fa fa-check"></i>
                                        保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->

    <!--<div class="footer">
        <div class="footer-inner">
            <div class="footer-content" style="padding: 0px;">
						<span class="bigger-120">
							<span class="blue bolder"></span>
							中国通广电子有限公司CRM管理系统 &copy; 2018
						</span>
                &nbsp; &nbsp;
            </div>
        </div>
    </div>-->
</div><!-- /.main-container -->
</div>
</body>
<script type="text/javascript">
    var permission = getCookie("permission");
    if(permission.indexOf("role-add")== -1){//如果没有添加按钮，则给查询form和表格之间加一个padding-top值
        $("#buttonDiv").addClass("buttonDiv");
    }
    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";
    jQuery(grid_selector).jqGrid({
        subGrid : false, // 此处设置为true时可以打开子项,子项用不到已删除
        url : "../role/list",// 获取数据的地址
        postData: transformToJson($('#roleSearchForm').serializeArray()),
        rownumbers : true,
        datatype : "json",
        mtype : "POST",
        hidegrid : false,//收缩列表按钮
        prmNames : {
            page : "pageNum",
            rows : "pageSize"
        },// 重新定义分页信息
        width:"100%",
        autowidth:true,
        height:350,
        colNames : ['','角色名称','排序序号', '备注','操作'],
        colModel : [
            {name:'id',index:'id',sortable:false,hidden:true},
            {name:'name',index:'name',sortable:false},
            {name:'priority',index:'priority',sortable:false},
            {name:'remark',index:'remark',sortable:false},
            {name:'_action',index:'_action',sortable:false,formatter:customFormatter}
        ],
        rowNum : 10,
        rowList : [10, 20, 30],
        pager : pager_selector,
        altRows : true,
        viewrecords : true,
        emptyrecords : "0条数据",
        loadComplete : function(data) {
            var table = this;
            setTimeout(function() {
                $("#jqgh_grid-table_rn").empty().append("序号");//第一列加上列名
                updatePagerIcons(table);//美化【首页，下一页，上一页，末页】
            }, 0);
        },
        jsonReader : { // jsonReader来跟服务器端返回的数据做对应
            root : "dataRows", // 包含实际数据的数组
            page : "currPage", // 当前页
            total : "totalPage",// 总页数
            records : "totalCount", // 查询出的记录数
            repeatitems : true
        },
        caption : "角色列表"
    });
    $(window).triggerHandler('resize.jqGrid');//trigger window resize to make the grid get the correct size

    //navButtons
    jQuery(grid_selector).jqGrid('navGrid',pager_selector,
        { 	//navbar options
            edit: false,
            add: false,
            del: false,
            search: false,
            refresh: false,
            view: false,
        }
    )

    //replace icons with FontAwesome icons like above
    function updatePagerIcons(table) {
        var replacement =
            {
                'ui-icon-seek-first' : 'ace-icon fa fa-angle-double-left bigger-140',
                'ui-icon-seek-prev' : 'ace-icon fa fa-angle-left bigger-140',
                'ui-icon-seek-next' : 'ace-icon fa fa-angle-right bigger-140',
                'ui-icon-seek-end' : 'ace-icon fa fa-angle-double-right bigger-140'
            };
        $('.ui-pg-table:not(.navtable) > tbody > tr > .ui-pg-button > .ui-icon').each(function(){
            var icon = $(this);
            var $class = $.trim(icon.attr('class').replace('ui-icon', ''));
            if($class in replacement) icon.attr('class', 'ui-icon '+replacement[$class]);
        })
    }

    $(function(){
        $(window).resize(function(){
            $("#grid-table").setGridWidth($(window).width()*0.96);
        });
    });

    function search(){
        jQuery(grid_selector).setGridParam({
            url : "../role/list",// 获取数据的地址
            postData: transformToJson($('#roleSearchForm').serializeArray()),
        }).trigger("reloadGrid",[{ page: 1}]);
        return false;
    }

    function  deleteOne(id){
        bootbox.confirm({
            buttons: {
                confirm: {
                    label: '确认',
                    className: 'btn-myStyle'
                },
                cancel: {
                    label: '取消',
                    className: 'btn-default'
                }
            },
            title: "提示信息",
            message: '确定要删除该角色吗？',
            callback: function(result) {
                if(result) {
                    $.ajax({
                        url:"../role/delete",    //请求的url地址
                        dataType:"json",
                        async:false,
                        data:{
                            id: id
                        },
                        type:"GET",
                        success:function(result){
                            if(result.code == '000000'){
                                jQuery(grid_selector).setGridParam({
                                }).trigger("reloadGrid");
                            }
                            if(result.code == '000001'){
                                parent.location.href = "../system/index";
                            }
                            if(result.code == '000002'){
                                window.location.href = "../system/403";
                            }
                        },
                        error:function(){
                            bootboxalert("服务器异常，请联系管理员");
                        }
                    });
                }
            },
        });
    }

    function customFormatter(cellvalue, options, rowObject){
        var str = "";
        if(permission.indexOf("role-delete")!= -1){
            str = str +"<a class='btn btn-minier btn-danger' href=\"javascript:deleteOne('"+rowObject[0]+"')\">" +
                "<i class='ace-icon fa fa-trash'></i>" +
                "</a>&nbsp;&nbsp;";
        }
        if(permission.indexOf("role-edit")!= -1){
            str = str + "<a class='btn btn-minier btn-info' href=\"javascript:openEdit('"+rowObject[0]+"')\">" +
                "<i class='ace-icon fa fa-pencil'></i>" +
                "</a>&nbsp;&nbsp;";
        }
        str = str + "<a class='btn btn-minier btn-success' href=\"javascript:openShow('"+rowObject[0]+"')\">" +
            "<i class='ace-icon fa fa-eye'></i>" +
            "</a>";
        return str ;
    }

    function openNew() {
        $("#modal-title").html("角色信息-添加");
        $("#roleSaveForm input").val("");
        $("#roleSaveForm textarea").val("");
        $(".modal-footer-btn").show();
        $('input,select,textarea',$('#roleSaveForm')).removeAttr('disabled');
    }

    function openEdit(id){
        $("#modal-title").html("角色信息-修改");
        $(".modal-footer-btn").show();
        huixian(id);
        $('input,select,textarea',$('#roleSaveForm')).removeAttr('disabled');
    }

    function openShow(id){
        $("#modal-title").html("角色信息-查看");
        $(".modal-footer-btn").hide();
        huixian(id);
        $('input,select,textarea',$('#roleSaveForm')).attr('disabled','disabled');
    }

    function  deleteOne(id){
        bootbox.confirm({
            buttons: {
                confirm: {
                    label: '确认',
                    className: 'btn-myStyle'
                },
                cancel: {
                    label: '取消',
                    className: 'btn-default'
                }
            },
            title: "提示信息",
            message: '确定要删除该角色吗？',
            callback: function(result) {
                if(result) {
                    $.ajax({
                        url:"../role/delete",    //请求的url地址
                        dataType:"json",
                        async:false,
                        data:{
                            id: id
                        },
                        type:"GET",
                        success:function(result){
                            switch (result.code){
                                case '000000':
                                    $("#modal-form").modal('hide');
                                    jQuery(grid_selector).setGridParam({
                                    }).trigger("reloadGrid");
                                    break;
                                case "000001":
                                    parent.location.href = "../system/index";
                                    break;
                                case "000002":
                                    window.location.href = "../system/403";
                                    break;
                                default :
                                    bootboxalert(result.msg);
                                    break;
                            }
                        },
                        error:function(){
                            bootboxalert("服务器异常，请联系管理员");
                        }
                    });
                }
            },
        });
    }

    function save(){
        $.ajax({
            url:"../role/save",    //请求的url地址
            dataType:"json",
            async:false,
            data:transformToJson($('#roleSaveForm').serializeArray()),
            type:"GET",
            success:function(result){
                switch (result.code){
                    case '000000':
                        $("#modal-form").modal('hide');
                        jQuery(grid_selector).setGridParam({
                        }).trigger("reloadGrid");
                        break;
                    case "000001":
                        parent.location.href = "../system/index";
                        break;
                    case "000002":
                        window.location.href = "../system/403";
                        break;
                    default :
                        bootboxalert(result.msg);
                        break;
                }
            },
            error:function(){
                bootboxalert("服务器异常，请联系管理员");
            }
        });
    }

    function huixian(id){
        $.ajax({
            url:"../role/getJsonById",    //请求的url地址
            dataType:"json",
            async:false,
            data:{
                id:id
            },
            type:"GET",
            success:function(result){
                var data = result.data;
                switch (result.code){
                    case '000000':
                        $("#roleId").val(data.id);
                        $("#savePriority").val(data.priority);
                        $("#saveName").val(data.name);
                        $("#saveRemark").val(data.remark);
                        break;
                    case "000001":
                        parent.location.href = "../system/index";
                        break;
                    case "000002":
                        window.location.href = "../system/403";
                        break;
                    default :
                        bootboxalert(result.msg);
                        break;
                }
                $("#modal-form").modal('show');
            },
            error:function(){
                bootboxalert("服务器异常，请联系管理员");
            }
        });
    }
</script>
</html>

