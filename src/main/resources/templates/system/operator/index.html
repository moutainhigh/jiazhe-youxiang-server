<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>CRM首页</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <!-- CSS -->
    <link rel="stylesheet" href="../static/init.css"/>

    <!-- Javascript -->
    <script src="../static/init.js"></script>
    <style>
        .form-group {
            margin-bottom: 0px;
        }
        #operatorSearchForm input{
            height: 30px;
        }
    </style>
</head>

<body class="no-skin">

<div class="main-container ace-save-state" id="main-container">
    <script type="text/javascript">
        try{ace.settings.loadState('main-container')}catch(e){}
    </script>

    <div class="main-content">
        <div class="main-content-inner">
            <div class="breadcrumbs ace-save-state" id="breadcrumbs">
                <ul class="breadcrumb">
                    <li>
                        <i class="ace-icon fa fa-home home-icon"></i>
                        <a href="../main/main_center">主页</a>
                    </li>
                    <li>
                        <a href="#">系统管理</a>
                    </li>
                    <li class="active">用户管理</li>
                </ul><!-- /.breadcrumb -->
            </div>

            <div class="page-content">
                <div class="row">
                    <div class="col-xs-12">
                        <form id="operatorSearchForm" class="form-horizontal" role="form">
                            <div class="form-group">
                                <label class="col-sm-1 control-label no-padding-right">用户姓名：</label>
                                <div class="col-sm-2">
                                    <div class="pos-rel">
                                        <input id="displayName" name="displayName" class="form-control" type="text" />
                                    </div>
                                </div>

                                <label class="col-sm-1 control-label no-padding-right">性别：</label>
                                <div class="col-sm-2">
                                    <select id="sex" name="sex" class="form-control">
                                        <option value="">  </option>
                                        <option value="1">男</option>
                                        <option value="2">女</option>
                                    </select>
                                </div>

                                <label class="col-sm-1 control-label no-padding-right">状态：</label>
                                <div class="col-sm-2">
                                    <select id="state" name="state" class="form-control">
                                        <option value="">    </option>
                                        <option value="0">禁用</option>
                                        <option value="1">启用</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-2"></div>
                            <div class="form-group">
                                <label class="col-sm-1 control-label no-padding-right">省/直辖市：</label>
                                <div class="col-sm-2">
                                    <select id="province" name="province" class="form-control" onchange="provinceChange()">
                                        <option value="">    </option>
                                        <option  th:each="p:${provinces}" th:value="${p.id}" th:text="${p.name}"></option>
                                    </select>
                                </div>

                                <label class="col-sm-1 control-label no-padding-right">城市：</label>
                                <div class="col-sm-2">
                                    <select id="city" name="city" class="form-control" onchange="cityChange()">
                                        <option value="">  </option>
                                    </select>
                                </div>

                                <label class="col-sm-1 control-label no-padding-right">区/县：</label>
                                <div class="col-sm-2">
                                    <select id="county" name="county" class="form-control">
                                        <option value="">  </option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-2"></div>
                            <div class="form-group">
                                <label class="col-sm-1 control-label no-padding-right">部门：</label>
                                <div class="col-sm-2">
                                    <select id="department" name="department" class="form-control">
                                        <option value="">  </option>
                                        <option  th:each="d:${departments}" th:value="${d.id}" th:text="${d.nameCN}"></option>
                                    </select>
                                </div>

                                <label class="col-sm-1 control-label no-padding-right">职位：</label>
                                <div class="col-sm-2">
                                    <select id="position" name="position" class="form-control">
                                        <option value="">  </option>
                                        <option  th:each="p:${positions}" th:value="${p.id}" th:text="${p.name}"></option>
                                    </select>
                                </div>

                                <label class="col-sm-1 control-label no-padding-right">角色：</label>
                                <div class="col-sm-2">
                                    <select id="role" name="role" class="form-control">
                                        <option value="">  </option>
                                        <option  th:each="r:${roles}" th:value="${r.id}" th:text="${r.name}"></option>
                                    </select>
                                </div>
                                <div class="col-sm-3">
                                    <button class="btn btn-white btn-default btn-round btn-sm" onclick="return search()">
                                        <i class="ace-icon fa fa-search red2"></i>
                                        查询
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div><!-- /.col -->
                    <div class="col-xs-12" style="text-align: right">
                        <p style="margin:1px;">
                            <shiro:hasPermission name="operator:add">
                                <a class="btn btn-success btn-round btn-sm" href="../operator/toAddOrEditPage?type=0">
                                    <i class="ace-icon fa fa-plus"></i>新建
                                </a>
                            </shiro:hasPermission>
                            <shiro:hasPermission name="operator:batchdelete">
                                <a class="btn btn-danger btn-round btn-sm" onclick="batchDelete()">
                                    <i class="ace-icon fa fa-trash"></i>批量删除
                                </a>
                            </shiro:hasPermission>
                        </p>
                    </div><!-- /.col -->
                    <div class="col-xs-12">
                        <table id="grid-table"></table>

                        <div id="grid-pager"></div>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->
    <!--<div class="footer">
        <div class="footer-inner">
            <div class="footer-content" style="padding: 0px;">
						<span class="bigger-120">
							<span class="blue bolder"></span>
							悠享后台管理系统 &copy; 2018
						</span>
                &nbsp; &nbsp;
            </div>
        </div>
    </div>-->
</div><!-- /.main-container -->
</body>
<script type="text/javascript">
    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";
    jQuery(grid_selector).jqGrid({
        subGrid : false, // 此处设置为true时可以打开子项,子项用不到已删除
        url : "../operator/list",// 获取数据的地址
        postData: transformToJson($('#operatorSearchForm').serializeArray()),
        rownumbers : true,
        datatype : "json",
        mtype : "POST",
        hidegrid : false,//收缩列表按钮
        prmNames : {
            page : "pageNum",
            rows : "pageSize"
        },// 重新定义分页信息
        width:"100%",
        autowidth:true,
        height:350,
        colNames : ['','登录名','用户姓名','性别', '部门', '职位','角色', '个人手机', '状态','入职时间','操作'],
        colModel : [
            {name:'id',index:'id',sortable:false,hidden:true},
            {name:'loginname',index:'loginname',sortable:false},
            {name:'displayname',index:'displayname', sortable:false},
            {name:'sex',index:'sex',sortable:false},
            {name:'department',index:'department',sortable:false},
            {name:'position',index:'position', sortable:false},
            {name:'role',index:'role', sortable:false},
            {name:'cellphone',index:'cellphone', sortable:false},
            {name:'state',index:'state',sortable:false},
            {name:'entrytime',index:'entrytime',sortable:false},
            {name:'_action',index:'_action',sortable:false,formatter:customFormatter}
        ],
        rowNum : 10,
        rowList : [10, 20, 30],
        pager : pager_selector,
        altRows : true,
        multiselect : true,
        multiboxonly : true,
        viewrecords : true,
        emptyrecords : "0条数据",
        loadComplete : function(data) {
            var table = this;
            setTimeout(function() {
                $("#jqgh_grid-table_rn").empty().append("序号");//第一列加上列名
                updatePagerIcons(table);//美化【首页，下一页，上一页，末页】
            }, 0);
        },
        jsonReader : { // jsonReader来跟服务器端返回的数据做对应
            root : "dataRows", // 包含实际数据的数组
            page : "currPage", // 当前页
            total : "totalPage",// 总页数
            records : "totalCount", // 查询出的记录数
            repeatitems : true
        },
        caption : "用户列表"
    });
    $(window).triggerHandler('resize.jqGrid');//trigger window resize to make the grid get the correct size

    //navButtons
    jQuery(grid_selector).jqGrid('navGrid',pager_selector,
        { 	//navbar options
            edit: false,
            add: false,
            del: false,
            search: false,
            refresh: false,
            view: false,
        }
    )

    //replace icons with FontAwesome icons like above
    function updatePagerIcons(table) {
        var replacement =
            {
                'ui-icon-seek-first' : 'ace-icon fa fa-angle-double-left bigger-140',
                'ui-icon-seek-prev' : 'ace-icon fa fa-angle-left bigger-140',
                'ui-icon-seek-next' : 'ace-icon fa fa-angle-right bigger-140',
                'ui-icon-seek-end' : 'ace-icon fa fa-angle-double-right bigger-140'
            };
        $('.ui-pg-table:not(.navtable) > tbody > tr > .ui-pg-button > .ui-icon').each(function(){
            var icon = $(this);
            var $class = $.trim(icon.attr('class').replace('ui-icon', ''));
            if($class in replacement) icon.attr('class', 'ui-icon '+replacement[$class]);
        })
    }

    $(function(){
        $(window).resize(function(){
            $("#grid-table").setGridWidth($(window).width()*0.96);
        });
    });

    function search(){
        jQuery(grid_selector).setGridParam({
            url : "../operator/list",// 获取数据的地址
            postData: transformToJson($('#operatorSearchForm').serializeArray()),
        }).trigger("reloadGrid",[{ page: 1}]);
        return false;
    }

    function batchDelete() {
        var rows=$(grid_selector).jqGrid("getGridParam","selarrrow");
        var num = rows.length;
        if(num == 0){
            bootboxalert("至少选择一行后再删除");
            return false;
        }else{
            bootbox.confirm({
                buttons: {
                    confirm: {
                        label: '确认',
                        className: 'btn-myStyle'
                    },
                    cancel: {
                        label: '取消',
                        className: 'btn-default'
                    }
                },
                title: "提示信息",
                message: '确定要删除所选'+num+'条记录吗？',
                callback: function(result) {
                    var ids = [] ;
                    for(var i=0; i<num; i++){
                        ids.push($(grid_selector).jqGrid('getRowData',rows[i]).id);
                    }
                    if(result) {
                        $.ajax({
                            url:"../operator/batchdelete",    //请求的url地址
                            dataType:"json",
                            async:false,
                            data:{
                                ids : ids.join(";")
                            },
                            type:"GET",
                            success:function(result){
                                if(result.code == '000000'){
                                    jQuery(grid_selector).setGridParam({
                                    }).trigger("reloadGrid");
                                }
                                if(result.code == '000001'){
                                    parent.location.href = "../system/index";
                                }
                                if(result.code == '000002'){
                                    window.location.href = "../system/403";
                                }
                            },
                            error:function(){
                                bootboxalert("服务器异常，请联系管理员");
                            }
                        });
                    }
                },
            });
        }
    }

    function  deleteOne(id){
        bootbox.confirm({
            buttons: {
                confirm: {
                    label: '确认',
                    className: 'btn-myStyle'
                },
                cancel: {
                    label: '取消',
                    className: 'btn-default'
                }
            },
            title: "提示信息",
            message: '确定要删除该用户吗？',
            callback: function(result) {
                if(result) {
                    $.ajax({
                        url:"../operator/delete",    //请求的url地址
                        dataType:"json",
                        async:false,
                        data:{
                            id: id
                        },
                        type:"GET",
                        success:function(result){
                            if(result.code == '000000'){
                                jQuery(grid_selector).setGridParam({
                                }).trigger("reloadGrid");
                            }
                            if(result.code == '000001'){
                                parent.location.href = "../system/index";
                            }
                            if(result.code == '000002'){
                                window.location.href = "../system/403";
                            }
                        },
                        error:function(){
                            bootboxalert("服务器异常，请联系管理员");
                        }
                    });
                }
            },
        });
    }

    function customFormatter(cellvalue, options, rowObject){
        var str = "";
        if(permission.indexOf("operator-delete")!= -1){
            str = str +"<a class='btn btn-minier btn-danger' href=\"javascript:deleteOne('"+rowObject[0]+"')\">" +
              "<i class='ace-icon fa fa-trash'></i>" +
              "</a>&nbsp;&nbsp;";
        }
        if(permission.indexOf("operator-edit")!= -1){
            str = str + "<a class='btn btn-minier btn-info' href=\"../operator/toAddOrEditPage?type=1&id="+rowObject[0]+"\">" +
              "<i class='ace-icon fa fa-pencil'></i>" +
              "</a>&nbsp;&nbsp;";
        }
        str = str + "<a class='btn btn-minier btn-success' href=\"../operator/toAddOrEditPage?type=2&id="+rowObject[0]+"\">" +
        "<i class='ace-icon fa fa-eye'></i>" +
        "</a>";
        return str ;
    }

    function provinceChange(){
        var provinceId = $("#province").val();
        $("#city").empty();
        $("#city").append(citysToOptions(provinceId));
        $("#county").empty();
    }

    function cityChange(cityId){
        var cityId = $("#city").val();
        $("#county").empty();
        $("#county").append(citysToOptions(cityId));
    }

</script>
</html>

